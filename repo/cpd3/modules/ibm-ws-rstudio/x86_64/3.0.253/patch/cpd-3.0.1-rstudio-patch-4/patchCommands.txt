patch cm rstudio-configmap -p '{"metadata": {"labels": {"icpdata_addon_version": "3.0.253-4"}}, "data": {"rstudio-server.json": "{\n  \"displayName\":\"RStudio with R 3.6\",\n  \"description\":\"RStudio Server 1.2 with R 3.6\",\n  \"annotations\": [\n      {\n        \"name\": \"cloudpakName\",\n        \"value\": \"IBM Cloud Pak for Data\"\n      },\n      {\n        \"name\": \"cloudpakId\",\n        \"value\": \"eb9998dcc5d24e3eb5b6fb488f750fe2\"\n      },\n      {\n        \"name\": \"cloudpakVersion\",\n        \"value\": \"3.0.1\"\n      },\n      {\n        \"name\": \"productMetric\",\n        \"value\": \"VIRTUAL_PROCESSOR_CORE\"\n      },\n      {\n        \"name\": \"productChargedContainers\",\n        \"value\": \"All\"\n      },\n      {\n        \"name\": \"productID\",\n        \"value\": \"ICP4D-Watson-Studio-3-0-1\"\n      },\n      {\n        \"name\": \"productName\",\n        \"value\": \"IBM Watson Studio Local Services for IBM Cloud Pak for Data\"\n      },\n      {\n        \"name\": \"productVersion\",\n        \"value\": \"3.0.1\"\n      }\n  ],\n  \"author\":\"IBM\",\n  \"tested\":true,\n  \"isService\":true,\n  \"runtimeType\":\"rstudio\",\n  \"features\":[\n    \"environment\"\n  ],\n  \"portMappings\":[\n    {\n      \"servicePort\":8443,\n      \"containerPort\":8443,\n      \"protocol\":\"TCP\"\n    }\n  ],\n  \"env\": [{\"name\": \"JOB_EXEC_COMMAND\",\n\t     \"value\": \"[\\\"/opt/ibm/ws/bin/run_job.sh\\\"]\"}],\n  \"replicas\":1,\n  \"image\":\"{{.DockerRegistryPrefix}}/wslocal-runtime-rstudio:cpd301-251-amd64\",\n  \"privileged\":false,\n  \"command\":[\n    \"/scripts/icp4d/startup.sh\"\n  ],\n  \"volumes\":[\n    {\n      \"volume\":\"dbdrivers\",\n      \"mountPath\":\"/user-home/_global_/dbdrivers\",\n      \"subPath\":\"_global_/dbdrivers\",\n      \"readOnly\":true,\n      \"claimName\":\"user-home-pvc\"\n    },\n    {\n      \"volume\":\"cchome-R\",\n      \"mountPath\":\"/cc-home/_global_/R\",\n      \"subPath\":\"_global_/R\",\n      \"claimName\":\"cc-home-pvc\"\n    },\n    {\n      \"volume\":\"cchome-config-user-info\",\n      \"mountPath\":\"/cc-home/_global_/config/user-info\",\n      \"subPath\":\"_global_/config/user-info\",\n      \"readOnly\":true,\n      \"claimName\":\"cc-home-pvc\"\n    },\n    {\n      \"volume\":\"cchome-config-idleshutdown\",\n      \"mountPath\":\"/cc-home/_global_/config/.idleshutdown\",\n      \"subPath\":\"_global_/config/.idleshutdown\",\n      \"readOnly\":true,\n      \"claimName\":\"cc-home-pvc\"\n    },\n    {\n      \"volume\":\"cchome-customer-truststores\",\n      \"mountPath\":\"/cc-home/_global_/security/customer-truststores\",\n      \"subPath\":\"_global_/security/customer-truststores\",\n      \"readOnly\":true,\n      \"claimName\":\"cc-home-pvc\"\n    },\n    {\n      \"volume\":\"project_dir\",\n      \"mountPath\":\"/home/wsuser\",\n      \"claimName\":\"file-api-claim\",\n      \"subPath\":\"projects/$project_id/rstudio/$user_id\"\n    },\n    {\n      \"volume\":\"project_dir\",\n      \"mountPath\":\"/project_data/assets\",\n      \"claimName\":\"file-api-claim\",\n      \"subPath\":\"projects/$project_id/assets\"\n    }\n  ],\n  \"probes\":{\n    \"liveness\":{\n      \"path\":\"/css/icons.css\",\n      \"scheme\":\"https\",\n      \"port\":8443,\n      \"initialDelaySeconds\":60,\n      \"failureThreshold\":10,\n      \"timeoutSeconds\":2,\n      \"periodSeconds\":5\n    },\n    \"readiness\":{\n      \"path\":\"/css/icons.css\",\n      \"scheme\":\"https\",\n      \"port\":8443,\n      \"initialDelaySeconds\":10,\n      \"failureThreshold\":30,\n      \"timeoutSeconds\":2,\n      \"periodSeconds\":2\n    }\n  },\n  \"resources\":{\n    \"cpu\":{\n      \"request\":-1,\n      \"minimum\":1000\n    },\n    \"gpu\":{\n      \"request\":-1,\n      \"minimum\":0\n    },\n    \"memory\":{\n      \"request\":-1,\n      \"minimum\":2048\n    },\n    \"duration\":{\n      \"value\":-1,\n      \"units\":\"unix\"\n    }\n  },\n  \"terminationGracePeriod\":60,\n  \"lifecycle\":{\n    \"preStop\":{\n      \"exec\":{\n        \"command\":[\n          \"/bin/sh\",\n          \"-c\",\n          \"/usr/sbin/rstudio-server force-suspend-session $(pidof rsession)\"\n        ]\n      }\n    }\n  }\n}" }}'
patch cm rstudio-configmap -p '"data": { "prepull-rstudio-patch.json": "{\"apiVersion\": \"batch/v1\", \"kind\": \"Job\", \"metadata\": {\"name\": \"prepull-rstudio-patched-image-job\"}, \"spec\": {\"backoffLimit\": 6, \"completions\": 50, \"parallelism\": 50, \"template\": {\"spec\": {\"affinity\": {\"nodeAffinity\": {\"requiredDuringSchedulingIgnoredDuringExecution\": {\"nodeSelectorTerms\": [{\"matchExpressions\": [{\"key\": \"beta.kubernetes.io/arch\", \"operator\": \"In\", \"values\": [\"amd64\"] } ] } ] } }, \"podAntiAffinity\": {\"requiredDuringSchedulingIgnoredDuringExecution\": [{\"labelSelector\": {\"matchExpressions\": [{\"key\": \"run\", \"operator\": \"In\", \"values\": [\"preload-rstudio\"] } ] }, \"topologyKey\": \"kubernetes.io/hostname\"} ] } }, \"automountServiceAccountToken\": false, \"containers\": [{\"command\": [\"echo\", \"Image {{.DockerRegistryPrefix}}/wslocal-runtime-rstudio:cpd301-251-amd64 preloaded\"], \"image\": \"{{.DockerRegistryPrefix}}/wslocal-runtime-rstudio:cpd301-251-amd64\", \"imagePullPolicy\": \"IfNotPresent\", \"name\": \"preload-rstudio-container\", \"resources\": {\"limits\": {\"cpu\": \"100m\", \"memory\": \"128Mi\"}, \"requests\": {\"cpu\": \"100m\", \"memory\": \"128Mi\"} }, \"securityContext\": {\"allowPrivilegeEscalation\": false, \"capabilities\": {\"drop\": [\"ALL\"] }, \"privileged\": false, \"readOnlyRootFilesystem\": true, \"runAsNonRoot\": true, \"runAsUser\": 1000330999 }, \"terminationMessagePath\": \"/dev/termination-log\", \"terminationMessagePolicy\": \"File\"} ], \"dnsPolicy\": \"ClusterFirst\", \"restartPolicy\": \"OnFailure\", \"schedulerName\": \"default-scheduler\", \"securityContext\": {\"runAsNonRoot\": true, \"runAsUser\": 1000330999 }, \"serviceAccount\": \"cpd-viewer-sa\", \"serviceAccountName\": \"cpd-viewer-sa\", \"terminationGracePeriodSeconds\": 30 } } } }"}'
run preload-rstudio --generator run-pod/v1 --image {{.DockerRegistryPrefix}}/wslocal-rstudio-init:cpd301-15-amd64 --restart OnFailure --overrides '{"spec": {"containers": [{"command": ["/bin/sh", "-c", "ls /etc/config/;kubectl version;cat /etc/config/prepull-rstudio-patch.json;kubectl create -f /etc/config/prepull-rstudio-patch.json;sleep 10;echo Done"], "image": "{{.DockerRegistryPrefix}}/wslocal-rstudio-init:cpd301-15-amd64", "imagePullPolicy": "IfNotPresent", "name": "rstudio-container", "volumeMounts": [{"mountPath": "/etc/config", "name": "config-volume"} ] } ], "volumes": [{"configMap": {"defaultMode": 420, "name": "rstudio-configmap"}, "name": "config-volume"} ], "securityContext": {"runAsNonRoot": true, "runAsUser": 1000330999 }, "serviceAccount": "cpd-editor-sa", "serviceAccountName": "cpd-editor-sa", "readinessProbe": {"exec": {"command": ["cat", "/etc/config/prepull-rstudio-patch.json"] }, "failureThreshold": 3, "initialDelaySeconds": 15, "periodSeconds": 5, "successThreshold": 1, "timeoutSeconds": 1 } }}'
wait --for=condition=ready --timeout=10m pod/preload-rstudio
logs preload-rstudio
wait --for=condition=complete --timeout=30m job/prepull-rstudio-patched-image-job
delete job/prepull-rstudio-patched-image-job
delete pod/preload-rstudio