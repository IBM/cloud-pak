patch deploy wks-sire-training-sireg-de --patch '{"spec": {"template": {"spec": {"containers": [{"name": "server","image": "{{.DockerRegistryPrefix}}/sireg:wdc-20181119-cf4a181a-84-master-571d06ec-153-with-templates"}]}}}}'
patch configmap wks-sire-training-facade --patch '{"data": {"batchapply-job-template": "apiVersion: batch/v1\nkind: Job\nmetadata:\n  name: sire-batch-apply # not relevant\n  labels:\n    app.kubernetes.io/name: \"sire-training\"\n    helm.sh/chart: \"sire\"\n    app.kubernetes.io/managed-by: \"Tiller\"\n    app.kubernetes.io/instance: \"wks\"\n    release: \"wks\"\n    app.kubernetes.io/component: \"facade\"\nspec:\n  backoffLimit: 0\n  activeDeadlineSeconds: 1200 # this will be used as overall timeout, including time in queue\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: \"sire-training\"\n        helm.sh/chart: \"sire\"\n        app.kubernetes.io/managed-by: \"Tiller\"\n        app.kubernetes.io/instance: \"wks\"\n        release: \"wks\"\n        app.kubernetes.io/component: \"facade\"\n    spec:\n      restartPolicy: Never\n      ### IMAGE PULL SECRET\n      \n\n      volumes:\n      # secret reference that contains the etcd connection string for the model mesh sidecar container\n      - name: s3-root-certificate-secret\n        secret:\n          defaultMode: 420\n          secretName: wks-ibm-minio-tls\n          items:\n          - key: tls.cacrt\n            path: root.pem\n      - name: workspace\n        emptyDir: {}\n\n      containers:\n      - name: sire\n        image: {{.DockerRegistryPrefix}}/sire-train-runtime:wdc-20181119-cf4a181a-84-master-aaa77d0d-173\n        imagePullPolicy: IfNotPresent\n        command: [/opt/ibm/mnlp/scripts/sire-batch-apply.sh]\n        resources:\n          requests:\n            cpu:  200m\n          limits:\n            cpu: 1000m\n            memory:  5Gi\n        volumeMounts:\n        - name: workspace\n          mountPath: /opt/ibm/mnlp/workspace\n        - name: s3-root-certificate-secret\n          mountPath: /etc/ssl/s3/\n\n        env:\n        - name: SIRE_TRAIN_S3_ENDPOINT\n          value: https://wks-ibm-minio-svc.{{.Namespace}}.svc.cluster.local:9000\n        - name: AWS_CA_BUNDLE\n          value: /etc/ssl/s3/root.pem\n        - name: AWS_ACCESS_KEY_ID\n          valueFrom:\n            secretKeyRef:\n              name: minio-access-secret-wks\n              key: accesskey\n        - name: AWS_SECRET_ACCESS_KEY\n          valueFrom:\n            secretKeyRef:\n              name: minio-access-secret-wks\n              key: secretkey\n        - name: K8S_JOB_QUEUE_ADDRESS\n          value: wks-sire-training-jobq:8091\n\n        - name: SIRE_TRAIN_TEST_DATA_URI\n          value: [[.TestDataUri]]\n        - name: SIRE_TRAIN_MODEL_URI\n          value: [[.ModelUri]]\n        - name: SIRE_TRAIN_EVAL_RESULTS_URI\n          value: [[.TestResultsOutUri]]\n        - name: SIRE_TRAIN_LOGS_OUT_URI\n          value: [[.LogsOutUri]]\n"}}'
patch configmap wks-sire-training-facade --patch '{"data": {"train-job-template": "apiVersion: batch/v1\nkind: Job\nmetadata:\n  name: sire-train # not relevant, jobq scheduler will overwrite\n  labels:\n    app.kubernetes.io/name: \"sire-training\"\n    helm.sh/chart: \"sire\"\n    app.kubernetes.io/managed-by: \"Tiller\"\n    app.kubernetes.io/instance: \"wks\"\n    release: \"wks\"\n    app.kubernetes.io/component: \"facade\"\nspec:\n  backoffLimit: 0\n  activeDeadlineSeconds: 18000 # this will be used as overall timeout, including time in queue\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: \"sire-training\"\n        helm.sh/chart: \"sire\"\n        app.kubernetes.io/managed-by: \"Tiller\"\n        app.kubernetes.io/instance: \"wks\"\n        release: \"wks\"\n        app.kubernetes.io/component: \"facade\"\n    spec:\n      restartPolicy: Never\n      ### IMAGE PULL SECRET\n      \n\n      volumes:\n      # secret reference that contains the etcd connection string for the model mesh sidecar container\n      - name: s3-root-certificate-secret\n        secret:\n          defaultMode: 420\n          secretName: wks-ibm-minio-tls\n          items:\n          - key: tls.cacrt\n            path: root.pem\n      - name: workspace\n        emptyDir: {}\n\n      containers:\n      - name: sire\n        image: {{.DockerRegistryPrefix}}/sire-train-runtime:wdc-20181119-cf4a181a-84-master-aaa77d0d-173\n        imagePullPolicy: IfNotPresent\n        command: [/opt/ibm/mnlp/scripts/sire-train.sh]\n        resources:\n          requests:\n            cpu:  200m\n          limits:\n            cpu: 1000m\n            memory:  5Gi\n        volumeMounts:\n        - name: workspace\n          mountPath: /opt/ibm/mnlp/workspace\n        - name: s3-root-certificate-secret\n          mountPath: /etc/ssl/s3/\n\n        env:\n        - name: SIRE_TRAIN_S3_ENDPOINT\n          value: https://wks-ibm-minio-svc.{{.Namespace}}.svc.cluster.local:9000\n        - name: AWS_CA_BUNDLE\n          value: /etc/ssl/s3/root.pem\n        - name: AWS_ACCESS_KEY_ID\n          valueFrom:\n            secretKeyRef:\n              name: minio-access-secret-wks\n              key: accesskey\n        - name: AWS_SECRET_ACCESS_KEY\n          valueFrom:\n            secretKeyRef:\n              name: minio-access-secret-wks\n              key: secretkey\n        - name: K8S_JOB_QUEUE_ADDRESS\n          value: wks-sire-training-jobq:8091\n\n        - name: SIRE_TRAIN_LANGUAGE\n          value: [[.Language]]\n        - name: SIRE_TRAIN_TRAIN_DATA_URI\n          value: [[.TrainDataUri]]\n        - name: SIRE_TRAIN_MODEL_OUT_URI\n          value: [[.ModelOutUri]]\n        - name: SIRE_TRAIN_LOGS_OUT_URI\n          value: [[.LogsOutUri]]\n        [[if .TemplateMention -]]\n        - name: SIRE_TRAIN_TEMPLATE_MENTION\n          value: [[.TemplateMention]]\n        [[end -]]\n        [[if .TemplateCoref -]]\n        - name: SIRE_TRAIN_TEMPLATE_COREF\n          value: [[.TemplateCoref]]\n        [[end -]]\n        [[if .TemplateRelation -]]\n        - name: SIRE_TRAIN_TEMPLATE_RELATION\n          value: [[.TemplateRelation]]\n        [[end -]]\n"}}'
