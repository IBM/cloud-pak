patch cm runtime-addon-py37gpu -p '{"data": {"jupyter-py37gpu-server.json": "{\"displayName\":\"Jupyter with Python 3.7 and GPU\",\"description\":\"Jupyter Notebook Server with Python 3.6 and GPU support\",\"annotations\":[{\"name\":\"cloudpakName\",\"value\":\"IBM Cloud Pak for Data\"},{\"name\":\"cloudpakId\",\"value\":\"eb9998dcc5d24e3eb5b6fb488f750fe2\"},{\"name\":\"cloudpakVersion\",\"value\":\"3.0.1\"},{\"name\":\"productMetric\",\"value\":\"VIRTUAL_PROCESSOR_CORE\"},{\"name\":\"productChargedContainers\",\"value\":\"All\"},{\"name\":\"productID\",\"value\":\"ICP4D-Watson-Studio-3-0-1\"},{\"name\":\"productName\",\"value\":\"IBM Watson Studio Services for IBM Cloud Pak for Data\"},{\"name\":\"productVersion\",\"value\":\"3.0.1\"}],\"author\":\"IBM\",\"tested\":true,\"isService\":true,\"features\":[\"environment\",\"python\",\"worker\",\"gpu\"],\"runtimeType\":\"jupyter-py37gpu\",\"portMappings\":[{\"servicePort\":8888,\"containerPort\":8888,\"protocol\":\"TCP\"},{\"servicePort\":8889,\"containerPort\":8889,\"protocol\":\"TCP\"}],\"replicas\":1,\"image\":\"{{.DockerRegistryPrefix}}/wslocal-x86-runtime-py37cuda:cpd301-master-1725\",\"command\":[\"/usr/sbin/tini\",\"--\",\"/opt/ibm/ws/bin/setup_container.sh\"],\"env\":[{\"name\":\"APP_ENV_KG_CONNECT_TIMOUT\",\"value\":\"600\"},{\"name\":\"APP_ENV_KG_REQUEST_TIMOUT\",\"value\":\"600\"},{\"name\":\"NVIDIA_DRIVER_CAPABILITIES\",\"value\":\"compute,utility\"},{\"name\":\"NVIDIA_REQUIRE_CUDA\",\"value\":\"cuda>=10.1\"}],\"volumes\":[{\"volume\":\"scripts\",\"mountPath\":\"/cc-home/.scripts\",\"subPath\":\".scripts\",\"readOnly\":true,\"claimName\":\"cc-home-pvc\"},{\"volume\":\"dbdrivers\",\"mountPath\":\"/user-home/_global_/dbdrivers\",\"subPath\":\"_global_/dbdrivers\",\"readOnly\":true,\"claimName\":\"user-home-pvc\"},{\"volume\":\"wmllibpy3\",\"mountPath\":\"/cc-home/_global_/python-3\",\"subPath\":\"_global_/python-3\",\"readOnly\":true,\"claimName\":\"cc-home-pvc\"},{\"volume\":\"wmllibpy36\",\"mountPath\":\"/cc-home/_global_/python-3.7\",\"subPath\":\"_global_/python-3\",\"readOnly\":true,\"claimName\":\"cc-home-pvc\"},{\"volume\":\"wmllib2py3\",\"mountPath\":\"/user-home/_global_/python-3\",\"subPath\":\"_global_/python-3\",\"readOnly\":true,\"claimName\":\"user-home-pvc\"},{\"volume\":\"wmllib2py36\",\"mountPath\":\"/user-home/_global_/python-3.7\",\"subPath\":\"_global_/python-3.6\",\"readOnly\":true,\"claimName\":\"user-home-pvc\"},{\"volume\":\"truststores\",\"mountPath\":\"/cc-home/_global_/security/customer-truststores\",\"subPath\":\"_global_/security/customer-truststores\",\"readOnly\":true,\"claimName\":\"cc-home-pvc\"},{\"volume\":\"truststores2\",\"mountPath\":\"/user-home/_global_/security/customer-truststores\",\"subPath\":\"_global_/security/customer-truststores\",\"readOnly\":true,\"claimName\":\"user-home-pvc\"},{\"volume\":\"remoteimages\",\"mountPath\":\"/cc-home/_global_/.remote-images\",\"subPath\":\"_global_/.remote-images\",\"readOnly\":true,\"claimName\":\"cc-home-pvc\"},{\"volume\":\"project_dir\",\"mountPath\":\"/project_data/data_asset\",\"claimName\":\"file-api-claim\",\"subPath\":\"projects/$project_id/assets/data_asset\"},{\"volume\":\"notebookscript\",\"mountPath\":\"/opt/ibm/ws\",\"claimName\":\"cc-home-pvc\",\"readOnly\":true,\"subPath\":\"_global_/config/.notebookscripts/active_scripts\"},{\"volume\":\"user-home-conda\",\"mountPath\":\"/user-home/_global_/config/conda\",\"claimName\":\"user-home-pvc\",\"readOnly\":true,\"subPath\":\"_global_/config/conda\"},{\"volume\":\"cc-home-conda\",\"mountPath\":\"/cc-home/_global_/config/conda\",\"claimName\":\"cc-home-pvc\",\"readOnly\":true,\"subPath\":\"_global_/config/conda\"}],\"probes\":{\"liveness\":{\"path\":\"/api/monitor\",\"scheme\":\"https\",\"port\":8889,\"initialDelaySeconds\":120,\"timeoutSeconds\":20,\"periodSeconds\":60,\"failureThreshold\":6},\"readiness\":{\"path\":\"/api/monitor\",\"scheme\":\"https\",\"port\":8889,\"initialDelaySeconds\":15,\"timeoutSeconds\":10,\"periodSeconds\":10}},\"resources\":{\"cpu\":{\"request\":1000,\"minimum\":1000},\"gpu\":{\"request\":-1,\"minimum\":0},\"memory\":{\"request\":1024,\"minimum\":1024},\"duration\":{\"value\":-1,\"units\":\"unix\"}}}\n"}}'
patch cm runtime-addon-py37gpu -p '{"data": {"jupyter-lab-py37gpu-server.json": "{\"displayName\":\"Jupyterlab Notebook IDE with Python 3.7 and GPU\",\"description\":\"Jupyterlab Notebook IDE and GPU support\",\"annotations\":[{\"name\":\"cloudpakName\",\"value\":\"IBM Cloud Pak for Data\"},{\"name\":\"cloudpakId\",\"value\":\"eb9998dcc5d24e3eb5b6fb488f750fe2\"},{\"name\":\"cloudpakVersion\",\"value\":\"3.0.1\"},{\"name\":\"productMetric\",\"value\":\"VIRTUAL_PROCESSOR_CORE\"},{\"name\":\"productChargedContainers\",\"value\":\"All\"},{\"name\":\"productID\",\"value\":\"ICP4D-Watson-Studio-3-0-1\"},{\"name\":\"productName\",\"value\":\"IBM Watson Studio Services for IBM Cloud Pak for Data\"},{\"name\":\"productVersion\",\"value\":\"3.0.1\"}],\"author\":\"IBM\",\"tested\":true,\"isService\":true,\"features\":[\"environment\",\"python\",\"gpu\"],\"runtimeType\":\"jupyter-lab-py37gpu\",\"portMappings\":[{\"servicePort\":8888,\"containerPort\":8888,\"protocol\":\"TCP\"},{\"servicePort\":8889,\"containerPort\":8889,\"protocol\":\"TCP\"}],\"replicas\":1,\"image\":\"{{.DockerRegistryPrefix}}/wslocal-x86-runtime-py37cuda:cpd301-master-1725\",\"command\":[\"/usr/sbin/tini\",\"--\",\"/opt/ibm/ws/bin/setup_container.sh\"],\"env\":[{\"name\":\"NVIDIA_DRIVER_CAPABILITIES\",\"value\":\"compute,utility\"},{\"name\":\"NVIDIA_REQUIRE_CUDA\",\"value\":\"cuda>=10.1\"}],\"volumes\":[{\"volume\":\"dbdrivers\",\"mountPath\":\"/user-home/_global_/dbdrivers\",\"subPath\":\"_global_/dbdrivers\",\"readOnly\":true,\"claimName\":\"user-home-pvc\"},{\"volume\":\"wmllibpy3\",\"mountPath\":\"/cc-home/_global_/python-3\",\"subPath\":\"_global_/python-3\",\"readOnly\":true,\"claimName\":\"cc-home-pvc\"},{\"volume\":\"wmllibpy37\",\"mountPath\":\"/cc-home/_global_/python-3.7\",\"subPath\":\"_global_/python-3\",\"readOnly\":true,\"claimName\":\"cc-home-pvc\"},{\"volume\":\"wmllib2py3\",\"mountPath\":\"/user-home/_global_/python-3\",\"subPath\":\"_global_/python-3\",\"readOnly\":true,\"claimName\":\"user-home-pvc\"},{\"volume\":\"wmllib2py37\",\"mountPath\":\"/user-home/_global_/python-3.7\",\"subPath\":\"_global_/python-3.6\",\"readOnly\":true,\"claimName\":\"user-home-pvc\"},{\"volume\":\"truststores\",\"mountPath\":\"/cc-home/_global_/security/customer-truststores\",\"subPath\":\"_global_/security/customer-truststores\",\"readOnly\":true,\"claimName\":\"cc-home-pvc\"},{\"volume\":\"truststores2\",\"mountPath\":\"/user-home/_global_/security/customer-truststores\",\"subPath\":\"_global_/security/customer-truststores\",\"readOnly\":true,\"claimName\":\"user-home-pvc\"},{\"volume\":\"project_dir\",\"mountPath\":\"/project_data/data_asset\",\"claimName\":\"file-api-claim\",\"subPath\":\"projects/$project_id/assets/data_asset\"},{\"volume\":\"jupyterlab_dir\",\"mountPath\":\"/home/wsuser\",\"claimName\":\"file-api-claim\",\"subPath\":\"projects/$project_id/jupyterlab/$user_id\"},{\"volume\":\"notebookscript\",\"mountPath\":\"/opt/ibm/ws\",\"claimName\":\"cc-home-pvc\",\"readOnly\":true,\"subPath\":\"_global_/config/.notebookscripts/active_scripts\"},{\"volume\":\"user-home-conda\",\"mountPath\":\"/user-home/_global_/config/conda\",\"claimName\":\"user-home-pvc\",\"readOnly\":true,\"subPath\":\"_global_/config/conda\"},{\"volume\":\"cc-home-conda\",\"mountPath\":\"/cc-home/_global_/config/conda\",\"claimName\":\"cc-home-pvc\",\"readOnly\":true,\"subPath\":\"_global_/config/conda\"}],\"probes\":{\"liveness\":{\"path\":\"/api/monitor\",\"scheme\":\"https\",\"port\":8889,\"initialDelaySeconds\":120,\"timeoutSeconds\":20,\"periodSeconds\":60,\"failureThreshold\":6},\"readiness\":{\"path\":\"/api/monitor\",\"scheme\":\"https\",\"port\":8889,\"initialDelaySeconds\":15,\"timeoutSeconds\":10,\"periodSeconds\":10}},\"resources\":{\"cpu\":{\"request\":1000,\"minimum\":1000},\"gpu\":{\"request\":-1,\"minimum\":0},\"memory\":{\"request\":1024,\"minimum\":1024},\"duration\":{\"value\":-1,\"units\":\"unix\"}}}\n"}}'
patch cm runtime-addon-py37gpu -p '{"metadata": { "labels": {"icpdata_addon_version": "3.0.258"}}}'
delete pod patch-runtime-py37gpu-job --ignore-not-found
run patch-runtime-py37gpu-job --generator run-pod/v1 --image {{.DockerRegistryPrefix}}/environments-init-job:3.0.258.1571-amd64 --replicas 1 --restart OnFailure --overrides '{"spec":{"affinity":{"nodeAffinity":{"requiredDuringSchedulingIgnoredDuringExecution":{"nodeSelectorTerms":[{"matchExpressions":[{"key":"beta.kubernetes.io/arch","operator":"In","values":["amd64","ppc64le"]}]}]}}},"containers":[{"command":["/bin/bash","-c","/home/node/scripts/initializeNotebooks.sh --executePatch"],"image":"{{.DockerRegistryPrefix}}/environments-init-job:3.0.258.1571-amd64","imagePullPolicy":"Always","name":"patched-init-job-container","env":[{"name":"MODULE_NAME","value":"runtime-py37gpu"},{"name":"CURRENT_IMAGE","value":"{{.DockerRegistryPrefix}}/environments-init-job:3.0.258.1571-amd64"},{"name":"RUNTIME_IMAGE","value":"{{.DockerRegistryPrefix}}/wslocal-x86-runtime-py37cuda:cpd301-master-1725"},{"name":"APP_ENV_SCRIPTS_VERSION","value":"1571"},{"name":"JOBS_TO_BE_EXECUTED","value":"prepull copy"}],"resources":{"limits":{"cpu":"500m","memory":"256Mi"},"requests":{"cpu":"250m","memory":"128Mi"}},"securityContext":{"allowPrivilegeEscalation":false,"capabilities":{"drop":["ALL"]},"privileged":false,"readOnlyRootFilesystem":false,"runAsNonRoot":true}}],"restartPolicy":"OnFailure","securityContext":{"runAsNonRoot":true,"runAsUser":1000320999},"serviceAccount":"cpd-editor-sa","serviceAccountName":"cpd-editor-sa"}}'
