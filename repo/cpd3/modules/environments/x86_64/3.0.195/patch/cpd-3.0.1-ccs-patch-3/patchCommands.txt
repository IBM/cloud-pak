patch deployment ax-environments-api-deploy -p '{"spec": {"template": {"spec":{"containers": [{"name": "runtime", "image":"{{.DockerRegistryPrefix}}/environments:3.0.1_216-amd64"}]}}}}'
patch deployment ax-environments-ui-deploy -p '{"spec": {"template": {"spec":{"containers": [{"name": "runtime", "image":"{{.DockerRegistryPrefix}}/environments:3.0.1_216-amd64"}]}}}}'
run patch-environments-scripts --image {{.DockerRegistryPrefix}}/environments-init-job:3.0.1_216.1320-amd64 --replicas 1 --restart OnFailure --overrides '{"spec":{"template":{"spec":{"affinity":{"nodeAffinity":{"requiredDuringSchedulingIgnoredDuringExecution":{"nodeSelectorTerms":[{"matchExpressions":[{"key":"beta.kubernetes.io/arch","operator":"In","values":["amd64"]}]}]}}},"containers":[{"command":["/bin/bash","-c","/home/node/scripts/initializeNotebooks.sh --copyscripts=true"],"image":"{{.DockerRegistryPrefix}}/environments-init-job:3.0.1_216.1320-amd64","env":[{"name":"APP_ENV_SCRIPTS_VERSION","value":"1320"}],"imagePullPolicy":"Always","name":"patched-init-job-container","resources":{"limits":{"cpu":"200m","memory":"64Mi"},"requests":{"cpu":"100m","memory":"32Mi"}},"securityContext":{"allowPrivilegeEscalation":false,"capabilities":{"drop":["ALL"]},"privileged":false,"readOnlyRootFilesystem":false,"runAsNonRoot":true},"volumeMounts":[{"mountPath":"/cc-home","name":"cc-home-mount"}]}],"restartPolicy":"OnFailure","securityContext":{"runAsNonRoot":true,"runAsUser":1000320999},"serviceAccount":"cpd-editor-sa","serviceAccountName":"cpd-editor-sa","volumes":[{"name":"cc-home-mount","persistentVolumeClaim":{"claimName":"cc-home-pvc"}}]}}}}'
run patch-environments-envspecsupdate --image {{.DockerRegistryPrefix}}/environments-init-job:3.0.1_216.1320-amd64 --replicas 1 --restart OnFailure --overrides '{"spec":{"template":{"spec":{"affinity":{"nodeAffinity":{"requiredDuringSchedulingIgnoredDuringExecution":{"nodeSelectorTerms":[{"matchExpressions":[{"key":"beta.kubernetes.io/arch","operator":"In","values":["amd64"]}]}]}}},"containers":[{"command":["/bin/bash","-c","/home/node/scripts/initializeNotebooks.sh --updateEnvironmentSpecs"],"image":"{{.DockerRegistryPrefix}}/environments-init-job:3.0.1_216.1320-amd64","imagePullPolicy":"Always","name":"patched-init-job-container","resources":{"limits":{"cpu":"200m","memory":"64Mi"},"requests":{"cpu":"100m","memory":"32Mi"}},"securityContext":{"allowPrivilegeEscalation":false,"capabilities":{"drop":["ALL"]},"privileged":false,"readOnlyRootFilesystem":false,"runAsNonRoot":true},"volumeMounts":[{"mountPath":"/cc-home","name":"cc-home-mount"}]}],"restartPolicy":"OnFailure","securityContext":{"runAsNonRoot":true,"runAsUser":1000320999},"serviceAccount":"cpd-editor-sa","serviceAccountName":"cpd-editor-sa","volumes":[{"name":"cc-home-mount","persistentVolumeClaim":{"claimName":"cc-home-pvc"}}]}}}}'
run patch-environments-deletefile --image {{ .DockerRegistryPrefix }}/environments-init-job:3.0.1_216.1320-amd64 --replicas 1 --restart OnFailure --overrides '{"spec": {"template": {"spec": {"affinity": {"nodeAffinity": {"requiredDuringSchedulingIgnoredDuringExecution": {"nodeSelectorTerms": [{"matchExpressions": [{"key": "beta.kubernetes.io/arch","operator": "In","values": ["amd64"]}]}]}}},"containers": [{"command": ["/bin/bash", "-c", "/home/node/scripts/initializeNotebooks.sh --genericDeleteFiles"],"image": "{{.DockerRegistryPrefix }}/environments-init-job:3.0.1_216.1320-amd64","env": [{"name": "FILES_TO_BE_DELETED","value": "/cc-home/_global_/config/environments/software-specifications/spark23*"}],"imagePullPolicy": "Always","name": "patched-init-job-container","resources": {"limits": {"cpu": "200m","memory": "64Mi"},"requests": {"cpu": "100m","memory": "32Mi"}},"securityContext": {"allowPrivilegeEscalation": false,"capabilities": {"drop": ["ALL"]},"privileged": false,"readOnlyRootFilesystem": false,"runAsNonRoot": true},"volumeMounts": [{"mountPath": "/cc-home","name": "cc-home-mount"}]}],"restartPolicy": "OnFailure","securityContext": {"runAsNonRoot": true,"runAsUser": 1000320999},"serviceAccount": "cpd-editor-sa","serviceAccountName": "cpd-editor-sa","volumes": [{"name": "cc-home-mount","persistentVolumeClaim": {"claimName": "cc-home-pvc"}}]}}}}'
run patch-environments-cleanup --image {{.DockerRegistryPrefix}}/environments-init-job:3.0.1_216.1320-amd64 --replicas 1 --restart OnFailure --overrides '{"spec":{"template":{"spec":{"affinity":{"nodeAffinity":{"requiredDuringSchedulingIgnoredDuringExecution":{"nodeSelectorTerms":[{"matchExpressions":[{"key":"beta.kubernetes.io/arch","operator":"In","values":["amd64"]}]}]}}},"containers":[{"command":["/bin/bash","-c","/home/node/scripts/initializeNotebooks.sh --checkJobandCleanup=true"],"image":"{{.DockerRegistryPrefix}}/environments-init-job:3.0.1_216.1320-amd64","env":[{"name":"MONITORED_JOBS","value":" patch-environments-scripts patch-environments-envspecsupdate patch-environments-deletefile patch-environments-cleanup"}],"imagePullPolicy":"Always","name":"patched-init-job-container","resources":{"limits":{"cpu":"200m","memory":"64Mi"},"requests":{"cpu":"100m","memory":"32Mi"}},"securityContext":{"allowPrivilegeEscalation":false,"capabilities":{"drop":["ALL"]},"privileged":false,"readOnlyRootFilesystem":false,"runAsNonRoot":true}}],"restartPolicy":"OnFailure","securityContext":{"runAsNonRoot":true,"runAsUser":1000320999},"serviceAccount":"cpd-editor-sa","serviceAccountName":"cpd-editor-sa"}}}}'
