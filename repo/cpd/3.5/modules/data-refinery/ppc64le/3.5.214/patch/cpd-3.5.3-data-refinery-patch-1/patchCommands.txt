patch cm data-refinery-configmap -p '{"metadata": {"labels": {"icpdata_addon_version": "3.5.214-3"}}, "data": {"shaper-server.json": "{\n  \"displayName\": \"Data Refinery\",\n  \"description\": \"Data Refinery with OpenCPU and R support\",\n  \"annotations\": [\n    {\n      \"name\": \"cloudpakName\",\n      \"value\": \"IBM Cloud Pak for Data\"\n    },\n    {\n      \"name\": \"cloudpakId\",\n      \"value\": \"eb9998dcc5d24e3eb5b6fb488f750fe2\"\n    },\n    {\n      \"name\": \"cloudpakInstanceId\",\n      \"value\": \"\"\n    },\n    {\n      \"name\": \"productCloudpakRatio\",\n      \"value\": \"1:1\"\n    },\n    {\n      \"name\": \"productMetric\",\n      \"value\": \"VIRTUAL_PROCESSOR_CORE\"\n    },\n    {\n      \"name\": \"productChargedContainers\",\n      \"value\": \"All\"\n    },\n    {\n      \"name\": \"productID\",\n      \"value\": \"eb9998dcc5d24e3eb5b6fb488f750fe2\"\n    },\n    {\n      \"name\": \"productName\",\n      \"value\": \"IBM Data Refinery\"\n    },\n    {\n      \"name\": \"productVersion\",\n      \"value\": \"3.5.3\"\n    },\n    {\n      \"name\": \"hook.deactivate.cpd.ibm.com/command\",\n      \"value\": \"[]\"\n    },\n    {\n      \"name\": \"hook.activate.cpd.ibm.com/command\",\n      \"value\": \"[]\"\n    }\n  ],\n  \"labels\": [\n    {\n      \"name\": \"icpdsupport/addOnId\",\n      \"value\": \"rshaper\"\n    },\n    {\n      \"name\": \"icpdsupport/app\",\n      \"value\": \"api\"\n    }\n  ],\n  \"author\": \"IBM\",\n  \"tested\": true,\n  \"isService\": true,\n  \"runtimeType\": \"shaper\",\n  \"features\": [\"environment\"],\n  \"portMappings\": [\n    {\n      \"servicePort\": 8446,\n      \"containerPort\": 8446,\n      \"protocol\": \"TCP\"\n    }\n  ],\n  \"replicas\": 1,\n  \"image\": \"{{.DockerRegistryPrefix}}/shaper-server:3.5.904-ppc64le\",\n  \"privileged\": false,\n  \"command\": [\"/scripts/startup_icp4data.sh\"],\n  \"volumes\": [\n    {\n      \"volume\": \"scripts\",\n      \"mountPath\": \"/cc-home/.scripts\",\n      \"subPath\": \".scripts\",\n      \"claimName\": \"cc-home-pvc\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"customer-truststores\",\n      \"mountPath\": \"/cc-home/_global_/security/customer-truststores\",\n      \"subPath\": \"_global_/security/customer-truststores\",\n      \"claimName\": \"cc-home-pvc\",\n      \"readOnly\": true\n    }\n  ],\n  \"probes\": {\n    \"liveness\": {\n      \"path\": \"/shaper/ocpu/library/v2viz/info\",\n      \"scheme\": \"https\",\n      \"port\": 8446,\n      \"initialDelaySeconds\": 15,\n      \"timeoutSeconds\": 2,\n      \"periodSeconds\": 10,\n      \"failureThreshold\": 10\n    },\n    \"readiness\": {\n      \"path\": \"/shaper/ocpu/library/v2viz/info\",\n      \"scheme\": \"https\",\n      \"port\": 8446,\n      \"initialDelaySeconds\": 2,\n      \"timeoutSeconds\": 2,\n      \"periodSeconds\": 2,\n      \"failureThreshold\": 10\n    }\n  },\n  \"resources\": {\n    \"cpu\": {\n      \"request\": 200,\n      \"limit\": 4000\n    },\n    \"gpu\": {\n      \"request\": -1,\n      \"minimum\": 0\n    },\n    \"memory\": {\n      \"request\": 2048,\n      \"limit\": 5120\n    },\n    \"duration\": {\n      \"value\": -1,\n      \"units\": \"unix\"\n    }\n  }\n}\n"}}'
patch cm data-refinery-configmap -p '"data": { "prepull-shaper-patch.json": "{\"apiVersion\": \"batch/v1\", \"kind\": \"Job\", \"metadata\": {\"name\": \"prepull-shaper-patched-image-job\"}, \"spec\": {\"backoffLimit\": 6, \"completions\": 50, \"parallelism\": 50, \"template\": { \"metadata\": {\"labels\": {\"run\": \"prepull-shaper-patched-image-job\"}}, \"spec\": {\"affinity\": {\"nodeAffinity\": {\"requiredDuringSchedulingIgnoredDuringExecution\": {\"nodeSelectorTerms\": [{\"matchExpressions\": [{\"key\": \"beta.kubernetes.io/arch\", \"operator\": \"In\", \"values\": [\"ppc64le\"] } ] } ] } }, \"podAntiAffinity\": {\"requiredDuringSchedulingIgnoredDuringExecution\": [{\"labelSelector\": {\"matchExpressions\": [{\"key\": \"run\", \"operator\": \"In\", \"values\": [\"prepull-shaper-patched-image-job\"] } ] }, \"topologyKey\": \"kubernetes.io/hostname\"} ] } }, \"automountServiceAccountToken\": false, \"containers\": [{\"command\": [\"echo\", \"Image {{.DockerRegistryPrefix}}/shaper-server:3.5.904-ppc64le preloaded\"], \"image\": \"{{.DockerRegistryPrefix}}/shaper-server:3.5.904-ppc64le\", \"imagePullPolicy\": \"IfNotPresent\", \"name\": \"preload-shaper-container\", \"resources\": {\"limits\": {\"cpu\": \"100m\", \"memory\": \"512Mi\"}, \"requests\": {\"cpu\": \"100m\", \"memory\": \"512Mi\"} }, \"securityContext\": {\"allowPrivilegeEscalation\": false, \"capabilities\": {\"drop\": [\"ALL\"] }, \"privileged\": false, \"readOnlyRootFilesystem\": true, \"runAsNonRoot\": true, \"runAsUser\": 1000330999 }, \"terminationMessagePath\": \"/dev/termination-log\", \"terminationMessagePolicy\": \"File\"} ], \"dnsPolicy\": \"ClusterFirst\", \"restartPolicy\": \"OnFailure\", \"schedulerName\": \"default-scheduler\", \"securityContext\": {\"runAsNonRoot\": true, \"runAsUser\": 1000330999 }, \"serviceAccount\": \"cpd-viewer-sa\", \"serviceAccountName\": \"cpd-viewer-sa\", \"terminationGracePeriodSeconds\": 30 } } } }"}'
run preload-shaper --generator run-pod/v1 --image {{.DockerRegistryPrefix}}/shaper-preinstall:3.5.904-ppc64le --restart OnFailure --overrides '{"spec": {"containers": [{"command": ["/bin/sh", "-c", "ls /etc/config/;kubectl version;cat /etc/config/prepull-shaper-patch.json;kubectl create -f /etc/config/prepull-shaper-patch.json;sleep 60;echo Done"], "image": "{{.DockerRegistryPrefix}}/shaper-preinstall:3.5.904-ppc64le", "imagePullPolicy": "IfNotPresent", "name": "shaper-container", "readinessProbe": {"exec": {"command": ["/bin/sh", "-c", "kubectl get job/prepull-shaper-patched-image-job"] }, "failureThreshold": 3, "initialDelaySeconds": 15, "periodSeconds": 5, "successThreshold": 1, "timeoutSeconds": 1 }, "volumeMounts": [{"mountPath": "/etc/config", "name": "config-volume"} ] } ], "volumes": [{"configMap": {"defaultMode": 420, "name": "data-refinery-configmap"}, "name": "config-volume"} ], "securityContext": {"runAsNonRoot": true, "runAsUser": 1000330999 }, "serviceAccount": "cpd-editor-sa", "serviceAccountName": "cpd-editor-sa" }}'
wait --for=condition=ready --timeout=10m pod/preload-shaper
logs preload-shaper
wait --for=condition=complete --timeout=30m job/prepull-shaper-patched-image-job
delete job/prepull-shaper-patched-image-job
delete pod/preload-shaper
