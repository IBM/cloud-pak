patch deployment spss-modeler-flow-api --patch '{"spec": {"template": {"spec": {"containers": [{"name": "flow-api","image": "{{.DockerRegistryPrefix}}/flow-api:2649-x86-64"}]}}}}'
patch deployment spss-modeler-flow-ui --patch '{"spec": {"template": {"spec": {"containers": [{"name": "flow-ui","image": "{{.DockerRegistryPrefix}}/flow-ui:13045-x86-64"}]}}}}'
patch deployment spss-modeler-modeler-flow-api --patch '{"spec": {"template": {"spec": {"containers": [{"name": "modeler-flow-api","image": "{{.DockerRegistryPrefix}}/modeler-flow-api:676-x86-64"}]}}}}'
patch cm spss-modeler-ibm-wml-canvas-prod-configmap -p '{"metadata": {"labels": {"icpdata_addon_version": "3.5.6.1"}}, "data": {"spss-modeler-server.json": "{\"displayName\":\"SPSS Modeler\",\"description\":\"SPSS Modeler Runtime\",\"annotations\":[{\"name\":\"cloudpakName\",\"value\":\"IBM Watson Studio Premium Extension for IBM Cloud Pak for Data\"},{\"name\":\"cloudpakId\",\"value\":\"497aaae00a3f402dbcbb6ee00d1b924b\"},{\"name\":\"cloudpakVersion\",\"value\":\"3.5.6\"},{\"name\":\"productMetric\",\"value\":\"VIRTUAL_PROCESSOR_CORE\"},{\"name\":\"productChargedContainers\",\"value\":\"All\"},{\"name\":\"productID\",\"value\":\"497aaae00a3f402dbcbb6ee00d1b924b\"},{\"name\":\"productName\",\"value\":\"IBM SPSS Modeler\"},{\"name\":\"productVersion\",\"value\":\"3.5.6\"}],\"author\":\"IBM\",\"tested\":true,\"isService\":true,\"runtimeType\":\"spss-modeler\",\"features\":[\"environment\",\"SPSS Modeler\",\"worker\"],\"portMappings\":[{\"servicePort\":9443,\"containerPort\":9443,\"protocol\":\"TCP\"}],\"replicas\":1,\"image\":\"{{ .DockerRegistryPrefix }}/flow-session:10666-x86-64\",\"privileged\":false,\"command\":[\".\/modeler-service-1.0\/scripts\/startup.sh\"],\"env\":[{\"name\":\"SERVICE_IMAGE_NAME\",\"value\":\"flow-session\"},{\"name\":\"CPUS_PER_POD\",\"value\":\"4\"},{\"name\":\"SERVICE_CPU\",\"value\":\"4\"},{\"name\":\"SERVICE_MEM\",\"value\":\"16Gi\"},{\"name\":\"MODELER_SERVER_HOST\",\"value\":\"localhost\"},{\"name\":\"DEVELOPMENT_MODE\",\"value\":\"false\"},{\"name\":\"PLAY_OPTS\",\"value\":\"-J-Xms1024M -J-Xmx3072M -J-Dfile.encoding=UTF-8\"},{\"name\":\"ULIMIT_MEM\",\"value\":\"8388608\"},{\"name\":\"OMP_NUM_THREADS\",\"value\":\"4\"},{\"name\":\"DEPLOYMENT_TARGET\",\"value\":\"local\"},{\"name\":\"LOCALFS_ROOT_PATH\",\"value\":\"\/\"},{\"name\":\"NGINX_SERVICE_SSL_CERTIFICATE_FILE_PATH\",\"value\":\"\/etc\/certificate\/certificate.pem\"},{\"name\":\"STREAMS_URL\",\"value\":\"https:\/\/internal-nginx-svc:12443\/canvas_api\"},{\"name\":\"ML_SERVICE_BASE_URL\",\"value\":\"https:\/\/internal-nginx-svc:12443\"},{\"name\":\"MODEL_VIEWER_SERVICE\",\"value\":\"https:\/\/internal-nginx-svc:12443\/model-viewer\"},{\"name\":\"MODEL_VIEWER_BROWSER_PREFIX\",\"value\":\"\/model-viewer\"}],\"probes\":{\"liveness\":{\"path\":\"\/monitor\",\"scheme\":\"https\",\"port\":9443,\"initialDelaySeconds\":90,\"failureThreshold\":3,\"timeoutSeconds\":3,\"periodSeconds\":30},\"readiness\":{\"path\":\"\/monitor\",\"scheme\":\"https\",\"port\":9443,\"initialDelaySeconds\":10,\"failureThreshold\":3,\"timeoutSeconds\":2,\"periodSeconds\":3}},\"volumes\":[{\"volume\":\"project_dir\",\"mountPath\":\"\/project_data\",\"claimName\":\"file-api-claim\",\"subPath\":\"projects\/$project_id\/assets\"}],\"resources\":{\"cpu\":{\"request\":2000,\"limit\":4000},\"gpu\":{\"request\":-1,\"minimum\":0},\"memory\":{\"request\":12288,\"limit\":16384},\"duration\":{\"value\":-1,\"units\":\"unix\"}}}"}}'
patch cm spss-modeler-ibm-wml-canvas-prod-configmap -p '"data": { "prepull-spss-patch.json": "{\"apiVersion\": \"batch/v1\", \"kind\": \"Job\", \"metadata\": {\"name\": \"spss-prepull-imagejobs\"}, \"spec\": {\"backoffLimit\": 6, \"completions\": 50, \"parallelism\": 50, \"template\": {\"spec\": {\"affinity\": {\"nodeAffinity\": {\"requiredDuringSchedulingIgnoredDuringExecution\": {\"nodeSelectorTerms\": [{\"matchExpressions\": [{\"key\": \"beta.kubernetes.io/arch\", \"operator\": \"In\", \"values\": [\"amd64\"] } ] } ] } }, \"podAntiAffinity\": {\"requiredDuringSchedulingIgnoredDuringExecution\": [{\"labelSelector\": {\"matchExpressions\": [{\"key\": \"run\", \"operator\": \"In\", \"values\": [\"preload-spss\"] } ] }, \"topologyKey\": \"kubernetes.io/hostname\"} ] } }, \"automountServiceAccountToken\": false, \"containers\": [{\"command\": [\"echo\", \"Image {{.DockerRegistryPrefix}}/flow-session:10666-x86-64 preloaded\"], \"image\": \"{{.DockerRegistryPrefix}}/flow-session:10666-x86-64\", \"imagePullPolicy\": \"IfNotPresent\", \"name\": \"preload-spss-container\", \"resources\": {\"limits\": {\"cpu\": \"100m\", \"memory\": \"128Mi\"}, \"requests\": {\"cpu\": \"100m\", \"memory\": \"128Mi\"} }, \"securityContext\": {\"allowPrivilegeEscalation\": false, \"capabilities\": {\"drop\": [\"ALL\"] }, \"privileged\": false, \"readOnlyRootFilesystem\": true, \"runAsNonRoot\": true, \"runAsUser\": 1000330999 }, \"terminationMessagePath\": \"/dev/termination-log\", \"terminationMessagePolicy\": \"File\"} ], \"dnsPolicy\": \"ClusterFirst\", \"restartPolicy\": \"OnFailure\", \"schedulerName\": \"default-scheduler\", \"securityContext\": {\"runAsNonRoot\": true, \"runAsUser\": 1000330999 }, \"serviceAccount\": \"cpd-viewer-sa\", \"serviceAccountName\": \"cpd-viewer-sa\", \"terminationGracePeriodSeconds\": 30 } } } }"}'
patch cm spss-modeler-ibm-wml-canvas-prod-configmap -p '{"metadata": { "labels": {"icpdata_addon_version": "3.5.6.1"}}}'
run preload-spss --generator run-pod/v1 --image {{.DockerRegistryPrefix}}/pre-installer:2496-x86-64 --restart OnFailure --overrides '{"spec": {"containers": [{"command": ["/bin/sh", "-c", "ls /etc/config/;kubectl version;cat /etc/config/prepull-spss-patch.json;kubectl create -f /etc/config/prepull-spss-patch.json;sleep 10;echo Done"], "image": "{{.DockerRegistryPrefix}}/pre-installer:2496-x86-64", "imagePullPolicy": "IfNotPresent", "name": "spss-container", "volumeMounts": [{"mountPath": "/etc/config", "name": "config-volume"} ] } ], "volumes": [{"configMap": {"defaultMode": 420, "name": "spss-modeler-ibm-wml-canvas-prod-configmap"}, "name": "config-volume"} ], "securityContext": {"runAsNonRoot": true, "runAsUser": 1000330999 }, "serviceAccount": "cpd-editor-sa", "serviceAccountName": "cpd-editor-sa", "readinessProbe": {"exec": {"command": ["cat", "/etc/config/prepull-spss-patch.json"] }, "failureThreshold": 3, "initialDelaySeconds": 15, "periodSeconds": 5, "successThreshold": 1, "timeoutSeconds": 1 } }}'
wait --for=condition=ready --timeout=10m pod/preload-spss
logs preload-spss
get job --selector job-name=spss-prepull-imagejobs
wait --for=condition=complete --timeout=30m job/spss-prepull-imagejobs
delete job/spss-prepull-imagejobs
delete pod/preload-spss
