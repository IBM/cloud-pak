patch deployment wdp-dataprep -p '{"spec": {"template": {"spec": {"containers": [{"name": "wdp-dataprep-container","image": "{{.DockerRegistryPrefix}}/wdp-dataprep:2.1.7-x86_64"}]}}}}'
patch cm shaper-configmap -p '{"data": {"shaper-server.json":"{\n  \"displayName\": \"Data Refinery\",\n  \"description\": \"Data Refinery with OpenCPU and R support\",\n  \"author\": \"IBM\",\n  \"tested\": true,\n  \"isService\": true,\n  \"runtimeType\": \"shaper\",\n  \"features\": [\"environment\"],\n  \"portMappings\": [\n    {\n      \"servicePort\": 8446,\n      \"containerPort\": 8446,\n      \"protocol\": \"TCP\"\n    }\n  ],\n  \"replicas\": 1,\n  \"image\": \"{{.DockerRegistryPrefix}}/shaper-server:2.5.643-x86_64\",\n  \"privileged\": false,\n  \"command\": [\"/scripts/startup_icp4data.sh\"],\n  \"volumes\": [\n    {\n      \"volume\": \"scripts\",\n      \"mountPath\": \"/cc-home/.scripts\",\n      \"subPath\": \".scripts\",\n      \"claimName\": \"cc-home-pvc\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"customer-truststores\",\n      \"mountPath\": \"/cc-home/_global_/security/customer-truststores\",\n      \"subPath\": \"_global_/security/customer-truststores\",\n      \"claimName\": \"cc-home-pvc\",\n      \"readOnly\": true\n    }\n  ],\n  \"probes\": {\n    \"liveness\": {\n      \"path\": \"/shaper/ocpu/library/v2viz/info\",\n      \"scheme\": \"http\",\n      \"port\": 8793,\n      \"initialDelaySeconds\": 120,\n      \"timeoutSeconds\": 10,\n      \"periodSeconds\": 10\n    },\n    \"readiness\": {\n      \"path\": \"/shaper/ocpu/library/v2viz/info\",\n      \"scheme\": \"http\",\n      \"port\": 8793,\n      \"initialDelaySeconds\": 15,\n      \"timeoutSeconds\": 10,\n      \"periodSeconds\": 10\n    }\n  },\n  \"resources\": {\n    \"cpu\": {\n      \"request\": 2000,\n      \"minimum\": 2000\n    },\n    \"gpu\": {\n      \"request\": -1,\n      \"minimum\": 0\n    },\n    \"memory\": {\n      \"request\": 5120,\n      \"minimum\": 5120\n    },\n    \"duration\": {\n      \"value\": -1,\n      \"units\": \"unix\"\n    }\n  }\n}\n"}}'
run shaper-server-patch-prepull-image-job --image {{ .DockerRegistryPrefix }}/shaper-server:2.5.643-x86_64 --restart OnFailure --overrides '{ "spec": {  "backoffLimit": 6,  "completions": 50,  "parallelism": 50,  "template": {"metadata": { "labels": {  "app": "imagePrepull",  "run": "shaper-server-patch-prepull-image" }},"spec": { "affinity": {  "nodeAffinity": {"requiredDuringSchedulingIgnoredDuringExecution": { "nodeSelectorTerms": [{  "matchExpressions": [{"key": "beta.kubernetes.io/arch","operator": "In","values": ["amd64"]  }] }]}  },  "podAntiAffinity": {"requiredDuringSchedulingIgnoredDuringExecution": [{ "labelSelector": {  "matchExpressions": [{"key": "run","operator": "In","values": ["shaper-server-patch-prepull-image"]  }] }, "topologyKey": "kubernetes.io/hostname"}]  } }, "containers": [{  "command": ["echo", "Image preloaded"],  "image": "{{ .DockerRegistryPrefix }}/shaper-server:2.5.643-x86_64",  "imagePullPolicy": "Always",  "name": "shaper-server-patch-prepull-image-container" }]}  } }}'
run shaper-server-patch-copycm-job --image {{ .DockerRegistryPrefix }}/shaper-preinstall:3.5.642-amd64 --replicas 1 --restart OnFailure --overrides '{"spec": {"template": {"spec": {"affinity": {"nodeAffinity": {"requiredDuringSchedulingIgnoredDuringExecution": {"nodeSelectorTerms": [{"matchExpressions": [{"key": "beta.kubernetes.io/arch","operator": "In","values": ["amd64"]}]}]}}},"containers": [{"command": ["/bin/bash", "-c", "/shaper_server_patch.sh --copyRTDEF=true"],"image": "{{.DockerRegistryPrefix }}/shaper-preinstall:3.5.642-amd64","env": [{"name": "RUNTIME_DEF_SOURCE_PATH","value": "/tmp/runtimedefinition/..data/shaper-server.json"}, {"name": "RUNTIME_DEF_TARGET_PATH","value": "/user-home/_global_/config/.runtime-definitions/ibm/shaper-server.json"}],"imagePullPolicy": "Always","name": "shaper-server-patch-copycm-container","resources": {"limits": {"cpu": "200m","memory": "64Mi"},"requests": {"cpu": "100m","memory": "32Mi"}},"securityContext": {"allowPrivilegeEscalation": false,"capabilities": {"drop": ["ALL"]},"privileged": false,"readOnlyRootFilesystem": false,"runAsNonRoot": true},"volumeMounts": [{"mountPath": "/tmp/runtimedefinition","name": "rt-def-cm"}]}],"restartPolicy": "OnFailure","securityContext": {"runAsNonRoot": true,"runAsUser": 1000320999},"serviceAccount": "cpd-editor-sa","serviceAccountName": "cpd-editor-sa","volumes": [{"name": "rt-def-cm","configMap": {"name": "shaper-configmap"}}]}}}}'
wait --for=condition=complete --timeout=30m job/shaper-server-patch-prepull-image-job job/shaper-server-patch-copycm-job
delete job/shaper-server-patch-prepull-image-job job/shaper-server-patch-copycm-job