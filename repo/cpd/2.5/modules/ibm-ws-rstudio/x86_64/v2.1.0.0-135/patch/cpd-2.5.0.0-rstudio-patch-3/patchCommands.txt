patch cm rstudio-configmap -p '{ "data": { "r-script-as-a-service-server.json": "{\n  \"displayName\": \"R 3.6.1 - Script as a Service\",\n  \"description\": \"R 3.6.1 running Plumber Server\",\n  \"author\": \"IBM\",\n  \"tested\": true,\n  \"isService\": false,\n  \"features\": [\"script-as-a-service\"],\n  \"runtimeType\": \"r-script-as-a-service\",\n  \"portMappings\": [\n    {\n      \"servicePort\": 7330,\n      \"containerPort\": 7330,\n      \"protocol\": \"TCP\"\n    }\n  ],\n  \"replicas\": 1,\n  \"image\": \"{{ .DockerRegistryPrefix }}/wslocal-runtime-rstudio:cpd250-285-amd64\",\n  \"command\": [\"/cc-home/.scripts/system/spawner/deployments/startup-r-server.sh\"],\n  \"volumes\": [\n    {\n      \"volume\": \"cchome-dbdrivers\",\n      \"mountPath\": \"/cc-home/_global_/dbdrivers\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/dbdrivers\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"cchome-R\",\n      \"mountPath\": \"/cc-home/_global_/R\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/R\"\n    },\n    {\n      \"volume\": \"cchome-config-user-info\",\n      \"mountPath\": \"/cc-home/_global_/config/user-info\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/config/user-info\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"cchome-config-idleshutdown\",\n      \"mountPath\": \"/cc-home/_global_/config/.idleshutdown\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/config/.idleshutdown\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"cchome-customer-truststores\",\n      \"mountPath\": \"/cc-home/_global_/security/customer-truststores\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/security/customer-truststores\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"project_dir\",\n      \"mountPath\": \"/project_data/rstudio\",\n      \"claimName\": \"file-api-claim\",\n      \"subPath\": \"projects/$project_id/rstudio/$user_id\"\n    },\n    {\n      \"volume\": \"project_dir\",\n      \"mountPath\": \"/project_data/assets\",\n      \"claimName\": \"file-api-claim\",\n      \"subPath\": \"projects/$project_id/assets\"\n    }\n  ],\n  \"probes\": {\n    \"liveness\": {\n      \"path\": \"/raas-server-healthcheck/healthcheck\",\n      \"scheme\": \"http\",\n      \"port\": 7330,\n      \"initialDelaySeconds\": 60,\n      \"timeoutSeconds\": 20,\n      \"periodSeconds\": 15\n    },\n    \"readiness\": {\n      \"path\": \"/raas-server-healthcheck/healthcheck\",\n      \"scheme\": \"http\",\n      \"port\": 7330,\n      \"initialDelaySeconds\": 62,\n      \"timeoutSeconds\": 22,\n      \"periodSeconds\": 10\n    }\n  },\n  \"resources\": {\n    \"cpu\": {\n      \"request\": 1000,\n      \"minimum\": 2000\n    },\n    \"gpu\": {\n      \"request\": 0,\n      \"minimum\": 0\n    },\n    \"memory\": {\n      \"request\": 5120,\n      \"minimum\": 5120\n    },\n    \"duration\": {\n      \"value\": -1,\n      \"units\": \"unix\"\n    }\n  }\n}\n", "rstudio-server.json": "{\n  \"displayName\":\"RStudio with R 3.6\",\n  \"description\":\"RStudio Server 1.2 with R 3.6\",\n  \"annotations\":[\n    {\n      \"name\":\"productId\",\n      \"value\":\"IBM Watson Studio Local Services for IBM Cloud Pak for Data\"\n    },\n    {\n      \"name\":\"productName\",\n      \"value\":\"IBM Watson Studio Local\"\n    },\n    {\n      \"name\":\"productVersion\",\n      \"value\":\"2.5\"\n    }\n  ],\n  \"author\":\"IBM\",\n  \"tested\":true,\n  \"isService\":true,\n  \"runtimeType\":\"rstudio\",\n  \"features\":[\n    \"environment\"\n  ],\n  \"portMappings\":[\n    {\n      \"servicePort\":8443,\n      \"containerPort\":8443,\n      \"protocol\":\"TCP\"\n    }\n  ],\n  \"replicas\":1,\n  \"image\":\"{{ .DockerRegistryPrefix }}/wslocal-runtime-rstudio:cpd250-285-amd64\",\n  \"privileged\":false,\n  \"command\":[\n    \"/scripts/icp4d/startup.sh\"\n  ],\n  \"volumes\":[\n    {\n      \"volume\":\"cchome-dbdrivers\",\n      \"mountPath\":\"/cc-home/_global_/dbdrivers\",\n      \"subPath\":\"_global_/dbdrivers\",\n      \"readOnly\":true,\n      \"claimName\":\"cc-home-pvc\"\n    },\n    {\n      \"volume\":\"cchome-R\",\n      \"mountPath\":\"/cc-home/_global_/R\",\n      \"subPath\":\"_global_/R\",\n      \"claimName\":\"cc-home-pvc\"\n    },\n    {\n      \"volume\":\"cchome-config-user-info\",\n      \"mountPath\":\"/cc-home/_global_/config/user-info\",\n      \"subPath\":\"_global_/config/user-info\",\n      \"readOnly\":true,\n      \"claimName\":\"cc-home-pvc\"\n    },\n    {\n      \"volume\":\"cchome-config-idleshutdown\",\n      \"mountPath\":\"/cc-home/_global_/config/.idleshutdown\",\n      \"subPath\":\"_global_/config/.idleshutdown\",\n      \"readOnly\":true,\n      \"claimName\":\"cc-home-pvc\"\n    },\n    {\n      \"volume\":\"cchome-customer-truststores\",\n      \"mountPath\":\"/cc-home/_global_/security/customer-truststores\",\n      \"subPath\":\"_global_/security/customer-truststores\",\n      \"readOnly\":true,\n      \"claimName\":\"cc-home-pvc\"\n    },\n    {\n      \"volume\":\"project_dir\",\n      \"mountPath\":\"/project_data/rstudio\",\n      \"claimName\":\"file-api-claim\",\n      \"subPath\":\"projects/$project_id/rstudio/$user_id\"\n    },\n    {\n      \"volume\":\"project_dir\",\n      \"mountPath\":\"/project_data/assets\",\n      \"claimName\":\"file-api-claim\",\n      \"subPath\":\"projects/$project_id/assets\"\n    }\n  ],\n  \"probes\":{\n    \"liveness\":{\n      \"path\":\"/\",\n      \"scheme\":\"http\",\n      \"port\":8787,\n      \"initialDelaySeconds\":120,\n      \"timeoutSeconds\":10,\n      \"periodSeconds\":10\n    },\n    \"readiness\":{\n      \"path\":\"/\",\n      \"scheme\":\"http\",\n      \"port\":8787,\n      \"initialDelaySeconds\":15,\n      \"timeoutSeconds\":10,\n      \"periodSeconds\":10\n    }\n  },\n  \"resources\":{\n    \"cpu\":{\n      \"request\":-1,\n      \"minimum\":1000\n    },\n    \"gpu\":{\n      \"request\":-1,\n      \"minimum\":0\n    },\n    \"memory\":{\n      \"request\":-1,\n      \"minimum\":2048\n    },\n    \"duration\":{\n      \"value\":-1,\n      \"units\":\"unix\"\n    }\n  }\n}\n", "rstudio-worker-server.json": "{\n  \"displayName\": \"RStudio with R 3.6\",\n  \"description\": \"RStudio Server 1.2 with R 3.6\",\n  \"author\": \"IBM\",\n  \"tested\": true,\n  \"isService\": false,\n  \"runtimeType\": \"rstudio-worker\",\n  \"features\": [\"worker\"],\n  \"portMappings\": [\n    {\n      \"servicePort\": 8443,\n      \"containerPort\": 8443,\n      \"protocol\": \"TCP\"\n    },\n    {\n      \"servicePort\": 3838,\n      \"containerPort\": 3838,\n      \"protocol\": \"TCP\"\n    }\n  ],\n  \"replicas\": 1,\n  \"image\": \"{{ .DockerRegistryPrefix }}/wslocal-runtime-rstudio:cpd250-285-amd64\",\n  \"command\": [\"/scripts/startup.sh\"],\n  \"volumes\": [\n    {\n      \"volume\": \"cchome-dbdrivers\",\n      \"mountPath\": \"/cc-home/_global_/dbdrivers\",\n      \"claimName\": \"cc-home-pvc-pvc\",\n      \"subPath\": \"_global_/dbdrivers\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"cchome-R\",\n      \"mountPath\": \"/cc-home/_global_/R\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/R\"\n    },\n    {\n      \"volume\": \"cchome-config-user-info\",\n      \"mountPath\": \"/cc-home/_global_/config/user-info\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/config/user-info\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"cchome-config-idleshutdown\",\n      \"mountPath\": \"/cc-home/_global_/config/.idleshutdown\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/config/.idleshutdown\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"cchome-customer-truststores\",\n      \"mountPath\": \"/cc-home/_global_/security/customer-truststores\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/security/customer-truststores\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"project_dir\",\n      \"mountPath\": \"/project_data/rstudio\",\n      \"claimName\": \"file-api-claim\",\n      \"subPath\": \"projects/$project_id/rstudio/$user_id\"\n    },\n    {\n      \"volume\": \"project_dir\",\n      \"mountPath\": \"/project_data/assets\",\n      \"claimName\": \"file-api-claim\",\n      \"subPath\": \"projects/$project_id/assets\"\n    }\n  ],\n  \"probes\": {\n    \"liveness\": {\n      \"path\": \"/\",\n      \"scheme\": \"http\",\n      \"port\": 8787,\n      \"initialDelaySeconds\": 120,\n      \"timeoutSeconds\": 10,\n      \"periodSeconds\": 10\n    },\n    \"readiness\": {\n      \"path\": \"/\",\n      \"scheme\": \"http\",\n      \"port\": 8787,\n      \"initialDelaySeconds\": 15,\n      \"timeoutSeconds\": 10,\n      \"periodSeconds\": 10\n    }\n  },\n  \"resources\": {\n    \"cpu\": {\n      \"request\": -1,\n      \"minimum\": 2000\n    },\n    \"gpu\": {\n      \"request\": -1,\n      \"minimum\": 0\n    },\n    \"memory\": {\n      \"request\": -1,\n      \"minimum\": 5120\n    },\n    \"duration\": {\n      \"value\": -1,\n      \"units\": \"unix\"\n    }\n  }\n}\n", "shiny-app-server.json": "{\n  \"displayName\": \"Shiny Server\",\n  \"description\": \"Used to serve R shiny apps\",\n  \"author\": \"IBM\",\n  \"tested\": true,\n  \"isService\": false,\n  \"features\": [\"shiny-app-server\"],\n  \"runtimeType\": \"shiny-server\",\n  \"portMappings\": [\n    {\n      \"servicePort\": 7330,\n      \"containerPort\": 7330,\n      \"protocol\": \"TCP\"\n    }\n  ],\n  \"replicas\": 1,\n  \"image\": \"{{ .DockerRegistryPrefix }}/wslocal-runtime-rstudio:cpd250-285-amd64\",\n  \"command\": [\"/cc-home/.scripts/system/spawner/deployments/startup-shiny-server.sh\"],\n  \"volumes\": [\n    {\n      \"volume\": \"cchome-dbdrivers\",\n      \"mountPath\": \"/cc-home/_global_/dbdrivers\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/dbdrivers\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"cchome-R\",\n      \"mountPath\": \"/cc-home/_global_/R\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/R\"\n    },\n    {\n      \"volume\": \"cchome-config-user-info\",\n      \"mountPath\": \"/cc-home/_global_/config/user-info\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/config/user-info\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"cchome-config-idleshutdown\",\n      \"mountPath\": \"/cc-home/_global_/config/.idleshutdown\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/config/.idleshutdown\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"cchome-customer-truststores\",\n      \"mountPath\": \"/cc-home/_global_/security/customer-truststores\",\n      \"claimName\": \"cc-home-pvc\",\n      \"subPath\": \"_global_/security/customer-truststores\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"project_dir\",\n      \"mountPath\": \"/project_data/rstudio\",\n      \"claimName\": \"file-api-claim\",\n      \"subPath\": \"projects/$project_id/rstudio/$user_id\"\n    },\n    {\n      \"volume\": \"project_dir\",\n      \"mountPath\": \"/project_data/assets\",\n      \"claimName\": \"file-api-claim\",\n      \"subPath\": \"projects/$project_id/assets\"\n    }\n  ],\n  \"probes\": {\n    \"liveness\": {\n      \"path\": \"/shiny-server-healthcheck\",\n      \"scheme\": \"http\",\n      \"port\": 7330,\n      \"initialDelaySeconds\": 15,\n      \"timeoutSeconds\": 10,\n      \"periodSeconds\": 15\n    },\n    \"readiness\": {\n      \"path\": \"/shiny-server-healthcheck\",\n      \"scheme\": \"http\",\n      \"port\": 7330,\n      \"initialDelaySeconds\": 15,\n      \"timeoutSeconds\": 10,\n      \"periodSeconds\": 10\n    }\n  },\n  \"resources\": {\n    \"cpu\": {\n      \"request\": 1000,\n      \"minimum\": 2000\n    },\n    \"gpu\": {\n      \"request\": 0,\n      \"minimum\": 0\n    },\n    \"memory\": {\n      \"request\": 2048,\n      \"minimum\": 2048\n    },\n    \"duration\": {\n      \"value\": -1,\n      \"units\": \"unix\"\n    }\n  },\n  \"sessionAffinity\": \"ClientIP\"\n}\n" }}'
run prepull-rstudio-patched-image-job --image {{ .DockerRegistryPrefix }}/wslocal-runtime-rstudio:cpd250-285-amd64 --restart OnFailure --overrides '{ "spec": {  "backoffLimit": 6,  "completions": 50,  "parallelism": 50,  "template": {"metadata": { "labels": {  "app": "imagePrepull",  "run": "patched-image-rstudio" }},"spec": { "affinity": {  "nodeAffinity": {"requiredDuringSchedulingIgnoredDuringExecution": { "nodeSelectorTerms": [{  "matchExpressions": [{"key": "beta.kubernetes.io/arch","operator": "In","values": ["amd64"]  }] }]}  },  "podAntiAffinity": {"requiredDuringSchedulingIgnoredDuringExecution": [{ "labelSelector": {  "matchExpressions": [{"key": "run","operator": "In","values": ["patched-image-rstudio"]  }] }, "topologyKey": "kubernetes.io/hostname"}]  } }, "containers": [{  "command": ["echo", "Image preloaded"],  "image": "{{ .DockerRegistryPrefix }}/wslocal-runtime-rstudio:cpd250-285-amd64",  "imagePullPolicy": "Always",  "name": "patched-image-rstudio-container" }]}  } }}'
wait --for=condition=complete --timeout=30m job/prepull-rstudio-patched-image-job
delete job/prepull-rstudio-patched-image-job
run patched-copycm-job-rstudio --image {{ .DockerRegistryPrefix }}/wslocal-rstudio-init:cpd250-33-amd64 --replicas 1 --restart OnFailure --overrides '{"spec": {"template": {"spec": {"affinity": {"nodeAffinity": {"requiredDuringSchedulingIgnoredDuringExecution": {"nodeSelectorTerms": [{"matchExpressions": [{"key": "beta.kubernetes.io/arch","operator": "In","values": ["amd64"]}]}]}}},"containers": [{"command": ["/bin/bash", "-c", "/scripts/initializeRStudio.sh --copyRTDEF=true"],"image": "{{.DockerRegistryPrefix }}/wslocal-rstudio-init:cpd250-33-amd64","env": [{"name": "RUNTIME_DEF_SOURCE_PATH","value": "/tmp/runtimedefinition/..data/rstudio-server.json"}, {"name": "RUNTIME_DEF_TARGET_PATH","value": "/user-home/_global_/config/.runtime-definitions/ibm/rstudio-server.json"}],"imagePullPolicy": "Always","name": "patched-init-job-container","resources": {"limits": {"cpu": "200m","memory": "64Mi"},"requests": {"cpu": "100m","memory": "32Mi"}},"securityContext": {"allowPrivilegeEscalation": false,"capabilities": {"drop": ["ALL"]},"privileged": false,"readOnlyRootFilesystem": false,"runAsNonRoot": true},"volumeMounts": [{"mountPath": "/tmp/runtimedefinition","name": "rt-def-cm"}]}],"restartPolicy": "OnFailure","securityContext": {"runAsNonRoot": true,"runAsUser": 1000320999},"serviceAccount": "cpd-editor-sa","serviceAccountName": "cpd-editor-sa","volumes": [{"name": "rt-def-cm","configMap": {"name": "rstudio-configmap"}}]}}}}'
wait --for=condition=complete --timeout=30m job/patched-copycm-job-rstudio
delete job/patched-copycm-job-rstudio