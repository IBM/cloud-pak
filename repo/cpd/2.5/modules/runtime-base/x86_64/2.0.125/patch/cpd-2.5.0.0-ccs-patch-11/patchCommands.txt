patch deployment utils-api --patch '{"spec": {"template": {"spec": {"containers": [{"name": "utils-api-container","image": "{{.DockerRegistryPrefix}}/privatecloud-utils-api:v3.13.1636-x86_64", "env": [{"name": "HAPROXY_IMAGE", "value": "{{.DockerRegistryPrefix}}/haproxy:v1.0.73-x86_64"}]}]}}}}'
patch cm dsx-core-configmap --patch '{"data": {"dsx-hi-server.json": "{\n  \"displayName\": \"DSX Hadoop Integration Proxy\",\n  \"description\": \"Proxy pod for forwarding DSXL python jobs to a registered remote DSX Hadoop Integration edge node.\",\n  \"annotations\": [\n    {\n      \"name\": \"productID\",\n      \"value\": \"ICP4D-addon-DataSciencePremium_HadoopIntegration_Job\"\n    },\n    {\n      \"name\": \"productName\",\n      \"value\": \"IBM Common Core Services for IBM Cloud Pak for Data\"\n    },\n    {\n      \"name\": \"productVersion\",\n      \"value\": \"3.0\"\n    }\n  ],\n  \"author\": \"IBM\",\n  \"tested\": true,\n  \"isService\": false,\n  \"isHidden\": true,\n  \"runtimeType\": \"dsx-hi\",\n  \"replicas\": 1,\n  \"image\": \"{{.DockerRegistryPrefix}}/privatecloud-dsx-hi-proxy:v3.13.1089-x86_64\",\n  \"privileged\": false,\n  \"command\": [\"/proxy_job\"],\n  \"volumes\": [\n    {\n      \"volume\": \"proxy-pod-scripts\",\n      \"mountPath\": \"/cc-home/.scripts/proxy-pods/dsx-hi\",\n      \"subPath\": \".scripts/proxy-pods/dsx-hi\",\n      \"claimName\": \"cc-home-pvc\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"spawner-scripts\",\n      \"mountPath\": \"/cc-home/.scripts/system/spawner\",\n      \"subPath\": \".scripts/system/spawner\",\n      \"claimName\": \"cc-home-pvc\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"common-helper-scripts\",\n      \"mountPath\": \"/cc-home/.scripts/common-helpers\",\n      \"subPath\": \".scripts/common-helpers\",\n      \"claimName\": \"cc-home-pvc\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"custom-certs\",\n      \"mountPath\": \"/cc-home/_global_/security/customer-truststores\",\n      \"subPath\": \"_global_/security/customer-truststores\",\n      \"claimName\": \"cc-home-pvc\",\n      \"readOnly\": true\n    },\n    {\n      \"volume\": \"remote-images\",\n      \"mountPath\": \"/cc-home/_global_/.remote-images/dsx-hi\",\n      \"subPath\": \"_global_/.remote-images/dsx-hi\",\n      \"claimName\": \"cc-home-pvc\"\n    }\n  ],\n  \"resources\": {\n    \"cpu\": {\n      \"request\": 300,\n      \"minimum\": 300\n    },\n    \"gpu\": {\n      \"request\": -1,\n      \"minimum\": 0\n    },\n    \"memory\": {\n      \"request\": 256,\n      \"minimum\": 256\n    },\n    \"duration\": {\n      \"value\": -1,\n      \"units\": \"unix\"\n    }\n  }\n}\n"}}'
run patched-hi-proxy-cm-job --image {{.DockerRegistryPrefix}}/privatecloud-dsx-hi-proxy:v3.13.1089-x86_64 --replicas 1 --restart OnFailure --overrides '{ "spec": { "template": { "spec": { "affinity": { "nodeAffinity": { "requiredDuringSchedulingIgnoredDuringExecution": { "nodeSelectorTerms": [ { "matchExpressions": [ { "key": "beta.kubernetes.io/arch", "operator": "In", "values": [ "amd64" ] } ] } ] } } }, "containers": [ { "command": [ "/bin/bash", "-c", "cp -f ${RUNTIME_DEF_SOURCE_PATH} ${RUNTIME_DEF_TARGET_PATH}" ], "image": "{{.DockerRegistryPrefix}}/privatecloud-dsx-hi-proxy:v3.13.1089-x86_64", "env": [ { "name": "RUNTIME_DEF_SOURCE_PATH", "value": "/tmp/runtimedefinition/..data/dsx-hi-server.json" }, { "name": "RUNTIME_DEF_TARGET_PATH", "value": "/user-home/_global_/config/.runtime-definitions/ibm/dsx-hi-server.json" } ], "imagePullPolicy": "Always", "name": "patched-hi-proxy-cm-job-container", "resources": { "limits": { "cpu": "200m", "memory": "64Mi" }, "requests": { "cpu": "100m", "memory": "32Mi" } }, "securityContext": { "allowPrivilegeEscalation": false, "capabilities": { "drop": [ "ALL" ] }, "privileged": false, "readOnlyRootFilesystem": false, "runAsNonRoot": true }, "volumeMounts": [ { "mountPath": "/tmp/runtimedefinition", "name": "dsxhi-def-cm" }, { "mountPath": "/user-home", "name": "user-home-mount" } ] } ], "restartPolicy": "OnFailure", "securityContext": { "runAsNonRoot": true, "runAsUser": 1000321000 }, "serviceAccount": "cpd-editor-sa", "serviceAccountName": "cpd-editor-sa", "volumes": [ { "name": "dsxhi-def-cm", "configMap": { "name": "dsx-core-configmap" } }, { "name": "user-home-mount", "persistentVolumeClaim": { "claimName": "user-home-pvc" } } ] } } } }'
wait --for=condition=complete --timeout=30m job/patched-hi-proxy-cm-job
delete job/patched-hi-proxy-cm-job
